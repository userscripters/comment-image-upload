// ==UserScript==
// @author          Jane Doe <jane@doe.com>
// @description     Userscript for uploading comment images
// @grant           none
// @homepage        https://github.com/userscripters/comment-image-upload#readme
// @match           https://*.askubuntu.com/questions/*
// @match           https://*.mathoverflow.net/questions/*
// @match           https://*.serverfault.com/questions/*
// @match           https://*.stackapps.com/questions/*
// @match           https://*.stackexchange.com/questions/*
// @match           https://*.stackoverflow.com/questions/*
// @name            Comment Image Upload
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/comment-image-upload.git
// @supportURL      https://github.com/userscripters/comment-image-upload/issues
// @version         0.1.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,d,i,s){return new(i=i||Promise)(function(a,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?a(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(n,r)}o((s=s.apply(e,d||[])).next())})},__generator=this&&this.__generator||function(a,n){var r,o,d,i={label:0,sent:function(){if(1&d[0])throw d[1];return d[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,o&&(d=2&t[0]?o.return:t[0]?o.throw||((d=o.return)&&d.call(o),0):o.next)&&!(d=d.call(o,t[1])).done)return d;switch(o=0,(t=d?[2&t[0],d.value]:t)[0]){case 0:case 1:d=t;break;case 4:return i.label++,{value:t[1],done:!1};case 5:i.label++,o=t[1],t=[0];continue;case 7:t=i.ops.pop(),i.trys.pop();continue;default:if(!(d=0<(d=i.trys).length&&d[d.length-1])&&(6===t[0]||2===t[0])){i=0;continue}if(3===t[0]&&(!d||t[1]>d[0]&&t[1]<d[3])){i.label=t[1];break}if(6===t[0]&&i.label<d[1]){i.label=d[1],d=t;break}if(d&&i.label<d[2]){i.label=d[2],i.ops.push(t);break}d[2]&&i.ops.pop(),i.trys.pop();continue}t=n.call(a,i)}catch(e){t=[6,e],o=0}finally{r=d=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__read=this&&this.__read||function(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var n,r,o=a.call(e),d=[];try{for(;(void 0===t||0<t--)&&!(n=o.next()).done;)d.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(a=o.return)&&a.call(o)}finally{if(r)throw r.error}}return d},__spreadArray=this&&this.__spreadArray||function(e,t,a){if(a||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||((n=n||Array.prototype.slice.call(t,0,r))[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};!function(d,i){function u(e,t,a){var n=void 0===(s=(l=void 0===a?{}:a).classes)?[]:s,r=l.title,o=void 0!==(i=l.danger)&&i,d=l.loading,a=void 0!==d&&d,i=void 0!==(s=l.muted)&&s,s=void 0!==(d=l.primary)&&d,l=void 0===(d=l.type)?"filled":d;return(d=document.createElement("button")).id=e,d.textContent=t,(e=d.classList).add.apply(e,__spreadArray(["s-btn","s-btn__".concat(l)],__read(n),!1)),d.setAttribute("role","button"),d.setAttribute("aria-label",r||t),o&&d.classList.add("s-btn__danger"),i&&d.classList.add("s-btn__muted"),s&&d.classList.add("s-btn__primary"),a&&d.classList.add("is-loading"),r&&(d.title=r),d}d.addEventListener("load",function(){var e,o=function(e,t,a){var n=void 0===a?{}:a,r=n.classes,o=void 0===r?[]:r,d=n.danger,i=void 0!==d&&d,a=n.fullscreen,r=void 0!==a&&a,d="modal-title",n=document.createElement("aside");(a=n.classList).add.apply(a,__spreadArray(["s-modal"],__read(o),!1)),n.id=e,n.tabIndex=-1,n.setAttribute("role","dialog"),n.setAttribute("aria-labelledby",d),n.setAttribute("aria-describeddy","modal-description"),n.setAttribute("aria-hidden","true"),i&&n.classList.add("s-modal__danger");i=n.dataset;i.sModalTarget="modal",i.controller="s-modal";i=document.createElement("div");i.classList.add("s-modal--dialog","ps-relative","hmx6","w90"),i.setAttribute("role","document"),i.id="".concat(e,"-document"),r&&i.classList.add("s-modal__full");e=document.createElement("h1");e.classList.add("s-modal--header"),e.id=d,e.textContent=t;r=document.createElement("button");r.classList.add("s-modal--close","s-btn","s-btn__muted"),r.type="button",r.dataset.action="s-modal#hide";d="http://www.w3.org/2000/svg",t=document.createElementNS(d,"svg");t.setAttribute("aria-hidden","true"),t.setAttribute("viewBox","0 0 14 14"),t.setAttribute("width","14"),t.setAttribute("height","14"),t.classList.add("svg-icon","iconClearSm");d=document.createElementNS(d,"path");return d.setAttribute("d","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"),t.append(d),r.append(t),i.append(e,r),n.append(i),n}("comment-image-modal","Image Uploader");document.body.append(o);var t=function(e,t,a){var n=a.uploader,r=a.resetter,o=a.onReset,d=a.onUpload,i=document.createElement("div"),s=document.createElement("label");s.classList.add("d-block","s-label","mb4"),s.htmlFor=e,s.textContent=t;var l=document.createElement("div");l.dataset.controller="s-uploader";a=document.createElement("div");a.classList.add("s-uploader","mb24","wmx3"),a.dataset.target="s-uploader.uploader";var c=document.createElement("input");c.classList.add("s-uploader--input"),c.id=e,c.type="file",c.dataset.action="input->s-uploader#handleInput",c.setAttribute("data-s-uploader-target","input");t=document.createElement("div");t.classList.add("s-uploader--previews","d-none"),t.dataset.target="s-uploader.previews",t.toggleAttribute("data-s-uploader-show-on-input");e=document.createElement("div"),n=u.apply(void 0,__spreadArray(__spreadArray([],__read(n),!1),[{classes:["s-btn","s-btn__primary"]}],!1));n.disabled=!0,n.toggleAttribute("data-s-uploader-enable-on-input"),n.addEventListener("click",function(e){return d(e,c.files)});r=u.apply(void 0,__spreadArray(__spreadArray([],__read(r),!1),[{classes:["s-btn","d-none"]}],!1));return r.dataset.action="click->s-uploader#reset",r.toggleAttribute("data-s-uploader-show-on-input"),r.addEventListener("click",function(e){return null==o?void 0:o(e,c.files)}),e.append(n,r),l.append(a,e),a.append(c,t),i.append(s,l),i}("comment-image-uploader","Upload an Image",{resetter:["reset-uploader","Reset"],uploader:["submit-uploader","Upload"],onUpload:function(e,r){return __awaiter(void 0,void 0,void 0,function(){var t,a,n;return __generator(this,function(e){switch(e.label){case 0:return r?(a=__read(r,1),t=a[0],(a=new FormData).append("file",t),a.append("fkey",StackExchange.options.user.fkey),t=d.location.hostname,(t=new URL("https://".concat(t,"/upload/image"))).search=new URLSearchParams({method:"json"}).toString(),[4,fetch(t.toString(),{method:"POST",body:a})]):[2];case 1:return(n=e.sent()).ok?[4,n.json()]:[2];case 2:return(t=e.sent(),a=t.Success,n=t.UploadedImage,a)?(t="[](".concat(n,")"),(a=i.querySelector("textarea[name='comment']"))&&(n=new Event("keyup",{bubbles:!0}),a.textContent+=t,a.dispatchEvent(n),Stacks.hideModal(o)),[2]):[2]}})})}});null!==(e=o.querySelector(".s-modal--dialog"))&&void 0!==e&&e.append(t);function a(){i.querySelectorAll("div.js-comment-text-input-container").forEach(function(e,t){e.querySelector("[id^='upload-']")||((t=u("upload-".concat(t),"Upload image",{primary:!0})).addEventListener("click",function(){Stacks.showModal(o)}),e.append(t))})}new MutationObserver(function(e){e.flatMap(function(e){e=e.addedNodes;return __spreadArray([],__read(e),!1)}).some(function(e){return 3!==e.nodeType&&e.matches("textarea[name='comment']")})&&a()}).observe(i.body,{childList:!0,subtree:!0}),a()})}(window,document);